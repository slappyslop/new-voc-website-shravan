{% extends "base.html" %}

{% load static %}

{% load form_tags %}

{% block title %}Organize a Trip{% endblock %}

{% block head_content %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Setup tags searchable dropdown
            const tag_selector = document.getElementById('id_tags');
            new Choices(tag_selector, {
                removeItemButton: true,
                placeholder: true,
                placeholderValue: 'Select tags...',
                searchPlaceholderValue: 'Search tags...',
            });

            // Setup image upload handler for description rich text box
            function initializeQuill(quill) {
                const toolbar = quill.getModule("toolbar");
                toolbar.addHandler("image", function () {
                    const input = document.createElement("input");
                    input.setAttribute("type", "file");
                    input.setAttribute("accept", "image/*");
                    input.click();

                    input.onchange = async () => {
                        const file = input.files[0];
                        const formData = new FormData();
                        formData.append("image", file);

                        const response = await fetch("{% url 'quill_image_upload' %}", {
                            method: "POST",
                            body: formData,
                            headers: {
                                "X-CSRFToken": "{{ csrf_token }}"
                            }
                        });

                        const result = await response.json();

                        if (response.ok) {
                            const range = quill.getSelection();
                            quill.insertEmbed(range.index, "image", result.url);
                        }
                        else {
                            alert("Upload failed: " + (result.error || "Unknown error"));
                        }
                    };
                });
            }

            const quill = document.querySelector(".django-quill-widget");
            if (quill && quill.__quill) {
                initializeQuill(quill.__quill);
            } else {
                const checkQuill = setInterval(() => {
                    const retryWidget = document.querySelector(".django-quill-widget");
                    if (retryWidget && retryWidget.__quill) {
                        initializeQuill(retryWidget.__quill);
                        clearInterval(checkQuill);
                    }
                }, 50); 
            }

            // Setup signup tools checkbox
            const signup_tool_checkbox = document.querySelector('#id_use_signup');
            const signup_tool_div = document.getElementById('signup-tool-div');
            signup_tool_div.style.display = signup_tool_checkbox.checked ? 'block' : 'none';
            signup_tool_checkbox.addEventListener('change', function () {
                signup_tool_div.style.display = this.checked ? 'block' : 'none';
            });

            // Setup signup list visibility toggling
            function updateSignupListVisibility(fromOptionsName, endOptionsContainer) {
                const selected = document.querySelector(`input[name="${fromOptionsName}"]:checked`);
                if (selected && selected.value === "never") {
                    endOptionsContainer.style.display = "none";
                }
                else {
                    endOptionsContainer.style.display = "block";
                }
            }

            const radioGroups = [
                { startName: "interested_start_choice", endContainer: document.getElementById("interested-end-container") },
                { startName: "committed_start_choice", endContainer: document.getElementById("committed-end-container") },
                { startName: "going_start_choice", endContainer: document.getElementById("going-end-container") },
            ];

            radioGroups.forEach(group => {
                const radios = document.querySelectorAll(`input[name="${group.startName}"]`);
                radios.forEach(radio => {
                    radio.addEventListener("change", () => {
                        console.log("testing event listener");
                        updateSignupListVisibility(group.startName, group.endContainer)
                    });
                });

                updateSignupListVisibility(group.startName, group.endContainer)
            });
            
            // Setup pretrip checkbox
            const pretrip_checkbox = document.querySelector('#id_use_pretrip');
            const pretrip_div = document.getElementById('pretrip-div');
            pretrip_div.style.display = pretrip_checkbox.checked ? 'block' : 'none';
            pretrip_checkbox.addEventListener('change', function () {
                pretrip_div.style.display = this.checked ? 'block' : 'none';
            });

            // Setup pretrip location fields
            const pretrip_use_clubroom = document.getElementById("pretrip_use_clubroom");
            const pretrip_location_input = document.getElementById("id_pretrip_location");
            const pretrip_location_input_label = document.getElementById("pretrip_location_input_label")
            if (pretrip_location_input.value == 'VOC Clubroom') {
                pretrip_use_clubroom.checked = true;
            }
            pretrip_location_input.style.display = pretrip_use_clubroom.checked ? 'none' : 'block';
            pretrip_use_clubroom.addEventListener('change', function () {
                pretrip_location_input_label.style.display = this.checked ? 'none' : 'block';
                pretrip_location_input.style.display = this.checked ? 'none' : 'block';
                if (this.checked) {
                    pretrip_location_input.value = "VOC Clubroom";
                }
                else {
                    pretrip_location_input.value = "";
                }
            });

            // Setup datetime pickers
            flatpickr('.flatpickr', {
                enableTime: true,
                dateFormat: "Y-m-d H:i",
                locale: {
                    "firstDayOfWeek": 1
                }
            });

            // Setup publish confirmation modal
            const publishBtn = document.getElementById('publish-btn');
            const publishConfirmBtn = document.getElementById('publish-confirm-btn');
            const publishConfirmModal =document.getElementById('publish-confirm-modal');
            const tripForm = document.getElementById('trip-form');

            if (publishBtn && publishConfirmBtn && publishConfirmModal) {
                const modal = new bootstrap.Modal(publishConfirmModal);
                publishBtn.addEventListener('click', function (event) {
                    event.preventDefault();
                    modal.show();
                });

                publishConfirmBtn.addEventListener('click', function (event) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'action';
                    input.value = 'publish';
                    tripForm.appendChild(input);

                    tripForm.submit();
                    modal.hide();
                });
            }
        });
    </script>

    <style>
        .ql-editor {
            min-height: 200px;
        }
    </style>
{% endblock %}

{% block content %}
    <h2>Post a New Trip/Event</h2>
    {{ form.media }}
    <form method="post" id="trip-form">
        {% csrf_token %}
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
        {% endif %}

        {% render_form_field form.name %}

        <div class="mb-4" style="display: flex; padding: 10px; width: 50%">
            <div class="mx-2">{% render_form_field form.start_time %}</div>
            <div class="mx-2">{% render_form_field form.end_time %}</div>
        </div>

        {% render_form_field form.in_clubroom %}

        {% render_form_field form.status %}

        {% render_form_field form.tags %}

        {% render_form_field form.description %}

        {% render_form_field form.members_only_info %}

        {% render_form_field form.use_pretrip %}

        <div id="pretrip-div" class="bg-secondary bg-opacity-50 p-3 m-3 rounded">
            {% render_form_field form.pretrip_time %}
            <div class="mb-4">
                {{ form.pretrip_location.label_tag }}<br />
                <label>
                    VOC Clubroom <input type="checkbox" id="pretrip_use_clubroom">
                </label><br />
                <label id="pretrip_location_input_label">
                    Other: <input type="text" name="pretrip_location" id="id_pretrip_location" value="{{ form.pretrip_location.value }}">
                </label>
            </div>
        </div>

        {% render_form_field form.use_signup %}

        <div id="signup-tool-div" class="bg-secondary bg-opacity-50 p-3 m-3 rounded">
            {% render_form_field form.signup_question %}

            {% render_form_field form.max_participants %}

            <p>When should the <b>interested</b> list be open?</p>
            <div class="mb-4 d-flex">
                <div class="mx-2">
                    <strong>From:</strong><br>
                    {% for option in form.interested_start_choice %}
                        <label style="display: inline-flex; align-items: baseline; gap: 6px;">
                            {{ option.tag }}{{ option.choice_label }}
                            {% if option.data.value == "custom" %}
                                {% render_form_field form.interested_start %}
                            {% endif %}
                        </label><br>
                    {% endfor %}
                    {% if form.interested_start_choice.errors %}
                        {% for error in form.interested_start_choice.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    {% endif %}
                </div>
                <div class="mx-2" id="interested-end-container">
                    <strong>To:</strong><br>
                    {% for option in form.interested_end_choice %}
                        <label style="display: inline-flex; align-items: baseline; gap: 6px;">
                            {{ option.tag }}{{ option.choice_label }}
                            {% if option.data.value == "custom" %}
                                {% render_form_field form.interested_end %}
                            {% endif %}
                        </label><br>
                    {% endfor %}
                    {% if form.interested_end_choice.errors %}
                        {% for error in form.interested_end_choice.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>

            <p>When should the <b>committed</b> list be open?</p>
            <div class="mb-4 d-flex">
                <div class="mx-2">
                    <strong>From:</strong><br>
                    {% for option in form.committed_start_choice %}
                        <label style="display: inline-flex; align-items: baseline; gap: 6px;">
                            {{ option.tag }}{{ option.choice_label }}
                            {% if option.data.value == "custom" %}
                                {% render_form_field form.committed_start %}
                            {% endif %}
                        </label><br>
                    {% endfor %}
                    {% if form.committed_start_choice.errors %}
                        {% for error in form.committed_start_choice.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    {% endif %}
                </div>
                <div class="mx-2" id="committed-end-container">
                    <strong>To:</strong><br>
                    {% for option in form.committed_end_choice %}
                        <label style="display: inline-flex; align-items: baseline; gap: 6px;">
                            {{ option.tag }}{{ option.choice_label }}
                            {% if option.data.value == "custom" %}
                                {% render_form_field form.committed_end %}
                            {% endif %}
                        </label><br>
                    {% endfor %}
                    {% if form.committed_end_choice.errors %}
                        {% for error in form.committed_end_choice.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>

            <p>
                When should the <b>going</b> list be open? <br>
                (Select "Never" if you do not want to allow participants to sign themselves up as <b>going</b>. 
                The organizer will still be able to sign participants up as <b>going</b>)
            </p>
            <div class="mb-4 d-flex">
                <div class="mx-2">
                    <strong>From:</strong><br>
                    {% for option in form.going_start_choice %}
                        <label style="display: inline-flex; align-items: baseline; gap: 6px;">
                            {{ option.tag }}{{ option.choice_label }}
                            {% if option.data.value == "custom" %}
                                {% render_form_field form.going_start %}
                            {% endif %}
                        </label><br>
                    {% endfor %}
                    {% if form.going_start_choice.errors %}
                        {% for error in form.going_start_choice.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    {% endif %}
                </div>
                <div class="mx-2" id="going-end-container">
                    <strong>To:</strong><br>
                    {% for option in form.going_end_choice %}
                        <label style="display: inline-flex; align-items: baseline; gap: 6px;">
                            {{ option.tag }}{{ option.choice_label }}
                            {% if option.data.value == "custom" %}
                                {% render_form_field form.going_end %}
                            {% endif %}
                        </label><br>
                    {% endfor %}
                    {% if form.going_end_choice.errors %}
                        {% for error in form.going_end_choice.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        {% render_form_field form.drivers_required %}

        {% if not published %}
            <button type="submit" name="action" value="save" class="btn btn-secondary">Save without Publishing</button>
            <button class="btn btn-primary" id="publish-btn">Save and Publish</button>

            <div class="modal fade" id="publish-confirm-modal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Are you sure you want to publish this trip?</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p>
                                Once published, the trip will be visible to all VOC members.<br>
                                This action <b>cannot</b> be undone.
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="publish-confirm-btn">Yes, publish my trip</button>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <button type="submit" name="action" value="publish" class="btn btn-primary">Save</button>
        {% endif %}
    </form>
{% endblock %}
