{% extends "base.html" %}

{% load static %}
{% load role_tags %}

{% block title %}{{ trip.name }}{% endblock %}

{% block head_content %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Setup car checkbox
            const carCheckbox = document.querySelector('#id_can_drive');
            const carSpotsDiv = document.getElementById('car-spots-div');
            carSpotsDiv.style.display = carCheckbox.checked ? 'block' : 'none';
            carCheckbox.addEventListener('change', function () {
                carSpotsDiv.style.display = this.checked ? 'block' : 'none';
            });
        });

        function copyEmails(button) {
            const emails = button.dataset.emails;
            if (emails) {
                navigator.clipboard.writeText(emails)
                    .then(() => alert("Emails copied!"))
            }
        }
    </script>
{% endblock %}

{% block content %}
    <div class="container">
        <h2>{{ trip.name }}</h2>
        <h5>{{ trip.trip_date_as_str_long }}</h5>

        {% if request.user|is_member and trip.use_signup %}
            <a href="#signup-form">Jump to signup form</a>
        {% endif %}

        <p>
            <b>Organized by:</b> 
            {% if request.user|is_member %}
                {% for organizer in organizers %}
                    <a href="{% url 'profile' organizer.user__id %}">{{ organizer.first_name }} {{ organizer.last_name }}</a>{% if not forloop.last %}, {% endif %}
                {% endfor %}
            {% else %}
                {% for organizer in organizers %}
                    <a href="{% url 'profile' organizer.user__id %}">This member</a>{% if not forloop.last %}, {% endif %}
                {% endfor %}
            {% endif %}
        </p>

        <p>
            {{ description|safe }}
        </p>


        <!------------------------------- Signup Lists ------------------------------->
        {% if request.user|is_member %}
            {% if signups.interested or signups.committed or signups.going or signups.no_longer_interested or signups.bailed_from_committed or signups.no_longer_going %}
                <hr>
                <h5>Signup Lists</h5>
                <div id="signup-list">
                    {% if signups.going %}
                        <p><b>Going:</b></p>
                        <table class="table table-striped table-hover">
                            <tbody>
                                {% for signup in signups.going %}
                                    <tr data-email="{{ signup.email }}">
                                        <th scope="row">{{ forloop.counter }}</th>
                                        <td><a href="{% url 'profile' signup.id %}">{{ signup.name }}</a></td>
                                        {% if signup.signup_answer %}
                                            <td class="text-wrap text-break w-50">Says: {{ signup.signup_answer }}</td>
                                        {% endif %}
                                        {% if trip.drivers_required and signup.car_spots > 0 %}
                                            <td><b>Can drive: </b><span class="badge bg-info">{{ signup.car_spots }}</span></td>
                                        {% endif %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                            {% if trip.drivers_required %}
                                <tfoot>
                                    <tr>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td><b>{{ car_spots.going }}</b> car spots on this list</td>
                                    </tr>
                                </tfoot>
                            {% endif %}
                        </table>
                        <button 
                            class="btn btn-sm btn-primary mb-2" 
                            onclick="copyEmails(this)" 
                            data-emails="{{ signup_emails.interested|join:',' }}"
                        >Copy Going List Emails</button>
                    {% endif %}
                    {% if signups.committed %}
                        <p><b>Committed:</b></p>
                        <table class="table table-striped table-hover">
                            <tbody>
                                {% for signup in signups.committed %}
                                    <tr data-email="{{ signup.email }}">
                                        <th scope="row">{{ forloop.counter }}</th>
                                        <td><a href="{% url 'profile' signup.id %}">{{ signup.name }}</a></td>
                                        <td class="text-wrap text-break w-50">
                                            {% if signup.signup_answer %}
                                                Says: {{ signup.signup_answer }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if trip.drivers_required and signup.car_spots > 0 %}
                                                <b>Can drive:</b><span class="badge bg-info">{{ signup.car_spots }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if request.user in trip.organizers.all %}
                                                <a href="{% url 'mark_as_going' trip.id signup.id %}">Add to going list</a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                            {% if trip.drivers_required %}
                            <tfoot>
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td><b>{{ car_spots.committed }}</b> car spots on this list</td>
                                </tr>
                            </tfoot>
                            {% endif %}
                        </table>
                        <button 
                            class="btn btn-sm btn-primary mb-2" 
                            onclick="copyEmails(this)"
                            data-emails="{{ signup_emails.committed|join:',' }}"
                        >Copy Committed List Emails</button>
                    {% endif %}
                    {% if signups.interested %}
                        <p><b>Interested:</b></p>
                        <table class="table table-striped table-hover">
                            <tbody>
                                {% for signup in signups.interested %}
                                    <tr data-email="{{ signup.email }}">
                                        <th scope="row">{{ forloop.counter }}</th>
                                        <td>
                                            <a href="{% url 'profile' signup.id %}">{{ signup.name }}</a>
                                        </td>
                                        <td class="text-wrap text-break w-50">
                                            {% if signup.signup_answer %}
                                                <b>Says:</b> <i>{{ signup.signup_answer }}</i>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if trip.drivers_required and signup.car_spots > 0 %}
                                                <b>Can drive:</b><span class="badge bg-info">{{ signup.car_spots }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if request.user in trip.organizers.all %}
                                                <a href="{% url 'mark_as_going' trip.id signup.id %}">Add to going list</a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                            {% if trip.drivers_required %}
                                <tfoot>
                                    <tr>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td><b>{{ car_spots.interested }}</b> car spots on this list</td>
                                    </tr>
                                </tfoot>
                            {% endif %}
                        </table>
                        <button 
                            class="btn btn-sm btn-primary mb-2" 
                            onclick="copyEmails(this)"
                            data-emails="{{ signup_emails.interested|join:',' }}"
                        >Copy Interested List Emails</button>
                    {% endif %}
                    {% if signups.no_longer_going %}
                        <p><b>No Longer Going:</b></p>
                        <table class="table table-striped table-hover">
                            <tbody>
                                {% for signup in signups.no_longer_going %}
                                    <tr data-email="{{ signup.email }}">
                                        <th scope="row">{{ forloop.counter }}</th>
                                        <td>
                                            <a href="{% url 'profile' signup.id %}">{{ signup.name }}</a>
                                        </td>
                                        <td class="text-wrap text-break w-50">
                                            {% if signup.signup_answer %}
                                                <b>Says:</b> <i>{{ signup.signup_answer }}</i>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% endif %}
                    {% if signups.bailed_from_committed %}
                        <p><b>Bailed From Committed:</b></p>
                        <table class="table table-striped table-hover">
                            <tbody>
                                {% for signup in signups.bailed_from_committed %}
                                    <tr data-email="{{ signup.email }}">
                                        <th scope="row">{{ forloop.counter }}</th>
                                        <td>
                                            <a href="{% url 'profile' signup.id %}">{{ signup.name }}</a>
                                        </td>
                                        <td class="text-wrap text-break w-50">
                                            {% if signup.signup_answer %}
                                                <b>Says:</b> <i>{{ signup.signup_answer }}</i>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% endif %}
                    {% if signups.no_longer_interested %}
                        <p><b>No Longer Interested:</b></p>
                        <table class="table table-striped table-hover">
                            <tbody>
                                {% for signup in signups.no_longer_interested %}
                                    <tr data-email="{{ signup.email }}">
                                        <th scope="row">{{ forloop.counter }}</th>
                                        <td>
                                            <a href="{% url 'profile' signup.id %}">{{ signup.name }}</a>
                                        </td>
                                        <td class="text-wrap text-break w-50">
                                            {% if signup.signup_answer %}
                                                <b>Says:</b> <i>{{ signup.signup_answer }}</i>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% endif %}
                </div>
                <button 
                    class="btn btn-sm btn-primary mb-2" 
                    onclick="copyEmails(this)"
                    data-emails="{{ signup_emails.going|join:',' }},{{ signup_emails.committed|join:',' }},{{ signup_emails.interested|join:',' }}"
                >Copy All Emails</button>
            {% endif %}
        {% endif %}
        <hr>

        <!------------------------------- Signup form ------------------------------->
        {% if trip.use_signup %}
            {% if user_can_signup and not user_is_signed_up %} <!-- Excludes inactive honorary members -->
                <h5>Sign Up</h5>
                {% if trip.valid_signup_types %}
                    <form id="signup-form" method="post">
                        {% csrf_token %}
                        <div class="mb-4">
                            {{ form.type.label_tag }} {{ form.type }}
                            {% if form.type.errors %}
                                <small>{{ form.type.errors|striptags }}</small>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            {{ form.can_drive.label_tag }} {{ form.can_drive }}
                            {% if form.can_drive.errors %}
                                <small>{{ form.can_drive.errors|striptags }}</small>
                            {% endif %}
                        </div>

                        <div class="mb-4" id="car-spots-div">
                            {{ form.car_spots.label_tag }} {{ form.car_spots }}
                            {% if form.car_spots.errors %}
                                <small>{{ form.car_spots.errors }}</small>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            {{ form.signup_answer.label_tag }} <br />
                            {{ form.signup_answer }}
                            {% if form.signup_answer.errors %}
                                <small>{{ form.signup_answer.errors }}</small>
                            {% endif %}
                        </div>

                        <button type="submit" class="btn btn-primary">Submit</button>
                    </form>
                {% else %}
                    {% if trip.signup_info.interested.0 == 'not_yet_open' %}
                        <p>The interested list will open on <b>{{ trip.signup_info.interested.1|date:"M. j, Y"  }}</b> at <b>{{ trip.signup_info.interested.1|time:"g:i A" }}</b></p>
                    {% elif trip.signup_info.interested.0 == 'closed' %}
                        <p>The interested list has already closed</p>
                    {% endif %}

                    {% if trip.signup_info.committed.0 == 'not_yet_open' %}
                        <p>The committed list will open on <b>{{ trip.signup_info.committed.1|date:"M. j, Y"  }}</b> at <b>{{ trip.signup_info.committed.1|time:"g:i A" }}</b></p>
                    {% elif trip.signup_info.committed.0 == 'closed' %}
                        <p>The committed list has already closed</p>
                    {% endif %}
                {% endif %}
            {% elif not request.user.is_authenticated %}
                <p><a href="{% url 'account_login' %}?next={{ request.get_full_path|urlencode }}">Sign in</a> to sign up for this trip</p>
            {% elif not request.user|is_member %}
                <p><a href="{% url 'join'}">Join</a> the VOC to sign up for this trip</p>
            {% endif %}
        {% endif %}
        <hr>
    </div>
    
{% endblock %}
