{% extends "base.html" %}

{% load static %}
{% load role_tags %}

{% block title %}Trip Agenda{% endblock %}

{% block head_content %}
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" rel="stylesheet" />

    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const listDiv = document.getElementById('list_div');
            const calendarDiv = document.getElementById('calendar_div');
            const toggleButton = document.getElementById('calendar-toggle');
            var calendar = document.getElementById('calendar');

            // Set initial view to listView
            listDiv.style.display = 'block';
            calendarDiv.style.display = 'none';
            toggleButton.textContent = 'Switch to calendar view';

            // Initialize calendar view toggle logic
            toggleButton.addEventListener('click', function () {
                if (listDiv.style.display === 'none') {
                    listDiv.style.display = 'block';
                    calendarDiv.style.display = 'none';
                    toggleButton.textContent = 'Switch to calendar view'
                }
                else {
                    listDiv.style.display = 'none';
                    calendarDiv.style.display = 'block';
                    toggleButton.textContent = 'Switch to list view'
                    calendar.render();
                }
            });

            // Initialize FullCalendar object
            const events = JSON.parse('{{ trips_calendar|escapejs }}');
            const extendedEvents = events.map(event => ({
                ...event,
                extendedProps: {
                    ...event.extendedProps,
                    tags: event.tags || []
                }
            }));
            calendar = new FullCalendar.Calendar(calendar, {
                initialView: 'dayGridMonth',
                events: extendedEvents,
                eventClick: function(info) {
                    window.location.href = '/trips/details/' + info.event._def.publicId;
                },
                firstDay: 1
            });

            // Initialize Choices dropdown for trip tag filters
            const tripTagFilter = document.getElementById('trip-tag-filter');
            const tripTagChoices = new Choices(tripTagFilter, {
                placeholder: true,
                placeholderValue: "Filter by trip tags"
            });

            // Filtering logic for trip table
            const tableRows = document.querySelectorAll("#upcoming-table tbody tr");
            function applyTripTagFilters() {
                const selectedTripTags = tripTagChoices.getValue(true);

                // Filter table rows
                tableRows.forEach(row => {
                    const tags = row.dataset.tags ? row.dataset.tags.split(',') : [];
                    row.style.display = (selectedTripTags.length === 0 || selectedTripTags.some(tag => tags.includes(tag)))
                     ? ""
                    : "none";
                });

                // Filter calendar events
                calendar.getEvents().forEach(event => {
                    const tags = event.extendedProps.tags || [];
                    const showEvent = (selectedTripTags.length === 0) ||
                        selectedTripTags.some(tag => tags.includes(tag));
                    event.setProp('display', showEvent ? 'auto' : 'none');
                });
            }
            tripTagFilter.addEventListener("change", applyTripTagFilters);
        });
    </script>
    <style>
        h2 {
            display: flex;
            justify-content: space-between;
            margin: 10px;
        }
        .fc-event-time, .fc-event-title {
            padding: 0 1px;
            white-space: normal;
        };
    </style>

{% endblock %}

{% block content %}
    <div class="container">
        <h2>
            Upcoming Trips
            <button id="calendar-toggle" class="btn btn-outline-secondary"></button>
        </h2>
        <div class="mb-3">
            <select id="trip-tag-filter" multiple>
                {% for tag in all_trip_tags %}
                    <option value="{{ tag.name }}">{{ tag.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div id="list_div">
            <table id="upcoming-table" class="table table-striped">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Trip</th>
                        <th></th>
                        <th>Tags</th>
                    </tr>
                </thead>
                <tbody>
                    {% for month, trips in trips_list.items %}
                        <tr>
                            <td colspan="4" class="fs-5 fw-bold bg-primary bg-opacity-10"><strong>{{ month }}</strong></td>
                        </tr>
                        {% for trip in trips %}
                            <tr data-tags="{{ trip.tags.all|join:','}}">
                                <td>{{ trip.trip_date_as_str_short }}</td>
                                <td><a href="{% url 'trip_details' trip.id %}">{{ trip.name }}</a></td>
                                <td>
                                    {% if request.user|is_exec %}
                                        <a href="{% url 'trip_edit' trip.id %}">Edit</a>
                                    {% endif %}
                                </td>
                                <td>
                                    {% for tag in trip.tags.all %}
                                        <!-- VS Code may detect errors here... ignore them THIS SYNTAX WORKS!!! -->
                                        <span class="badge badge-pill" style="background-color: {{ tag.colour }}; color: white;">
                                            {{ tag.name }}
                                        </span>
                                    {% endfor %}
                                </td>
                            </tr>
                        {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    
        <div id="calendar_div">
            <div id="calendar"></div>
        </div>
    </div>
{% endblock %}
