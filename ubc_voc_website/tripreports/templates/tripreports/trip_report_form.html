
{% extends 'base.html' %}

{% block head_content %}
    {% include 'django_quill/media.html' %}

    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" rel="stylesheet" />

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Set up searchable trip dropdown
            const tripSelect = document.getElementById("trip-select");
            if (tripSelect) {
                new Choices(tripSelect, {
                    removeItemButton: true,
                    searchEnabled: true
                });
            }

            // Setup category dropdown
            const categorySelector = document.getElementById("id_categories");
            new Choices(categorySelector, {
                removeItemButton: true,
            });

            // Setup image upload handler for rich text box
            const quill = document.querySelector(".django-quill-widget").__quill;
            const toolbar = quill.getModule("toolbar");
            toolbar.addHandler("image", function () {
                const input = document.createElement("input");
                input.setAttribute("type", "file");
                input.setAttribute("accept", "image/*");
                input.click();

                input.onchange = async () => {
                    const file = input.files[0];
                    const formData = new FormData();
                    formData.append("image", file);

                    const response = await fetch("{% url 'quill_image_upload' %}", {
                        method: "POST",
                        body: formData,
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}"
                        }
                    });

                    const result = await response.json();
                    if (result.url) {
                        const range = quill.getSelection();
                        quill.insertEmbed(range.index, "image", result.url);
                    }
                };
            });
        });
    </script>
{% endblock %}

{% block content %}
    <div class="container">
        <h2>Create Trip Report</h2>
        <form method="post">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit" name="save" class="btn btn-secondary">Save</button>
            <button type="submit" name="submit" class="btn btn-primary">Submit for Review</button>
        </form>
    </div>
{% endblock %}